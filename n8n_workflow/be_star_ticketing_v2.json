{
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "bestar-whatsapp",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        5936,
        5504
      ],
      "id": "ab6a4ceb-3288-4e0d-8946-a93ffdd797ee",
      "name": "Whatsapp",
      "webhookId": "d8fa5154-f391-43c2-ad0c-f5c7b3eb2737"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "bestar-approval",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        5936,
        6600
      ],
      "id": "3945bd27-149a-4e85-8949-aca70e6b78ad",
      "name": "Approval Webhook",
      "webhookId": "9e913b19-87ad-44f4-9dc4-4bdb4ae0f556"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "803c1504-5ff1-4d19-8d9b-7c933466e48d",
              "name": "User_phone_ID",
              "value": "={{\n(() => {\n  const data = $json.body?.data?.key;\n  let rawNumber = '';\n  if (data?.remoteJidAlt?.includes('@s.whatsapp.net')) {\n    rawNumber = data.remoteJidAlt.split('@')[0];\n  } else if (data?.remote3lidAlt?.includes('@s.whatsapp.net')) {\n    rawNumber = data.remote3lidAlt.split('@')[0];\n  } else if (data?.remoteJid?.includes('@s.whatsapp.net')) {\n    rawNumber = data.remoteJid.split('@')[0];\n  } else {\n    rawNumber = (data?.remoteJid || '').split('@')[0];\n  }\n  rawNumber = rawNumber.trim();\n  if (rawNumber.startsWith('20')) {\n    return '0' + rawNumber.slice(2);\n  }\n  return '+' + rawNumber;\n})()\n}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6160,
        5504
      ],
      "id": "c4405af0-30f2-4787-99c2-3a580c5dfc0a",
      "name": "User Phone ID"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://access.mrailabs.com/api/check-access",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\"api_key\": \"Pi7HbQnp7lml2Ok30bBYq06dDbzD3oxxNEAdOQqeT38\", \"user_id\": $('User Phone ID').item.json.User_phone_ID, \"platform_type\": \"Whatsapp\", \"user_name\": $('Whatsapp').item.json.body.data.pushName}) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        6384,
        5504
      ],
      "id": "61bb6090-63d9-4c16-9ab2-7219347c94e9",
      "name": "Access Control4"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "857ccdd3-662c-44c6-aff6-9660ffa633fe",
              "leftValue": "={{ $json.access }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        6672,
        5504
      ],
      "id": "1693036d-7840-4f11-bf4e-5415fb177ef6",
      "name": "If8"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Whatsapp').first().json.body.data.messageType }}",
                    "rightValue": "conversation",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "35588a02-6475-400d-b869-da05d7ed0f3a"
                  },
                  {
                    "leftValue": "={{ $('Whatsapp').first().json.body.data.messageType }}",
                    "rightValue": "extendedTextMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "ext-text-msg-001"
                  }
                ],
                "combinator": "or"
              },
              "renameOutput": true,
              "outputKey": "Text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "83b9e800-99d0-4e31-8032-ae81aebe86d1",
                    "leftValue": "={{ $('Whatsapp').first().json.body.data.messageType }}",
                    "rightValue": "audioMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b70e2cfc-8de2-4f4c-a6c0-77c2028ba78f",
                    "leftValue": "={{ $('Whatsapp').first().json.body.data.messageType }}",
                    "rightValue": "imageMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Photos"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8c9c8324-851d-4d68-ab24-34d545eb07da",
                    "leftValue": "={{ $('Whatsapp').item.json.body.data.messageType }}",
                    "rightValue": "stickerMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Stickers"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        7200,
        5488
      ],
      "id": "c94c0911-6ae7-4e59-9bf8-80c4fd0b83bb",
      "name": "Switch3",
      "alwaysOutputData": false,
      "executeOnce": false
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2f35809b-3889-4ef7-a8d5-a4d934842631",
              "name": "Text",
              "value": "={{ $('Whatsapp').first().json.body?.data?.message?.conversation ?? $('Whatsapp').first().json.body?.data?.message?.extendedTextMessage?.text ?? '' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7888,
        4992
      ],
      "id": "2f0f4adf-6101-4620-8ed9-a7aa6830e391",
      "name": "Text4"
    },
    {
      "parameters": {
        "resource": "chat-api",
        "operation": "get-media-base64",
        "instanceName": "={{ $('Whatsapp').first().json.body.instance }}",
        "messageId": "={{ $('Whatsapp').first().json.body.data.key.id }}"
      },
      "type": "n8n-nodes-evolution-api-english.evolutionApi",
      "typeVersion": 1,
      "position": [
        7456,
        5504
      ],
      "id": "0ccb1e75-be62-4000-a099-8357f202eb8b",
      "name": "Get media in base1",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "evolutionApi": {
          "id": "IGwXyU5Jbou5S5V3",
          "name": "Business Number"
        }
      }
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "data.base64",
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        7600,
        5504
      ],
      "id": "0de261a8-acfa-4f5a-9355-7df38831cce6",
      "name": "Convert to File",
      "executeOnce": false,
      "alwaysOutputData": false,
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://38.242.139.159:5555/convert",
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "data",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        7776,
        5504
      ],
      "id": "318e8b70-ed9f-4b49-a284-1a18fbb2c749",
      "name": "Convert Audio Type3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mrai-openai.openai.azure.com/openai/deployments/gpt-4o-transcribe/audio/transcriptions?api-version=2025-03-01-preview",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api-key",
              "value": "5zSQL871XpyGNXgzSx0LPwzkCrPqYj52L5ODHMA0bs6stZlhi35xJQQJ99BKACfhMk5XJ3w3AAABACOGk5RF"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "file",
              "inputDataFieldName": "data"
            },
            {
              "name": "model",
              "value": "gpt-4o-transcribe"
            },
            {
              "name": "prompt",
              "value": "\"Transcribe accurately. Speaker uses Arabic with English words mixed in. Keep English terms in English.\""
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        7952,
        5504
      ],
      "id": "643b1719-0253-44c3-8df1-4264f42fe7e8",
      "name": "Transcribe a recording1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://access.mrailabs.com/api/log-usage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "api_key",
              "value": "Pi7HbQnp7lml2Ok30bBYq06dDbzD3oxxNEAdOQqeT38"
            },
            {
              "name": "execution_id",
              "value": "={{ $execution.id }}"
            },
            {
              "name": "request_type",
              "value": "transcription"
            },
            {
              "name": "model",
              "value": "gpt-4o-transcribe"
            },
            {
              "name": "input_tokens",
              "value": "={{ $json.usage?.prompt_tokens ?? 0 }}"
            },
            {
              "name": "output_tokens",
              "value": "={{ $json.usage?.completion_tokens ?? 0 }}"
            },
            {
              "name": "platform_user_id",
              "value": "={{ $('User Phone ID').item.json.User_phone_ID }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        8144,
        5504
      ],
      "id": "4e59102e-3aaa-4f42-9849-363043d38f67",
      "name": "Cost Calculator"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2f35809b-3889-4ef7-a8d5-a4d934842631",
              "name": "Voice",
              "value": "={{ $('Transcribe a recording1').item.json.text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        8304,
        5232
      ],
      "id": "e6d01f7b-a751-4960-9b33-6ef686b7edfd",
      "name": "Voice"
    },
    {
      "parameters": {
        "resource": "chat-api",
        "operation": "get-media-base64",
        "instanceName": "={{ $('Whatsapp').first().json.body.instance }}",
        "messageId": "={{ $('Whatsapp').first().json.body.data.key.id }}"
      },
      "type": "n8n-nodes-evolution-api-english.evolutionApi",
      "typeVersion": 1,
      "position": [
        7488,
        5872
      ],
      "id": "bfa001d0-abca-437b-bb22-19bd32161552",
      "name": "Get Image Base64",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "evolutionApi": {
          "id": "IGwXyU5Jbou5S5V3",
          "name": "Business Number"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mrai-openai.services.ai.azure.com/models/chat/completions?api-version=2024-05-01-preview",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api-key",
              "value": "5zSQL871XpyGNXgzSx0LPwzkCrPqYj52L5ODHMA0bs6stZlhi35xJQQJ99BKACfhMk5XJ3w3AAABACOGk5RF"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "x-ms-model-mesh-model-name",
              "value": "mistral-medium-2505"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"model\":\"mistral-medium-2505\",\"messages\":[{\"role\":\"user\",\"content\":[{\"type\":\"text\",\"text\":\"ÙˆØµÙ Ø§Ù„ØµÙˆØ±Ø© Ø¯ÙŠ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø¨Ø´ÙƒÙ„ Ù…Ø®ØªØµØ±. Ù„Ùˆ ÙÙŠÙ‡Ø§ Ù†Øµ Ø£Ùˆ ÙƒÙ„Ø§Ù…ØŒ Ø§ÙƒØªØ¨Ù‡. Ù„Ùˆ ÙÙŠÙ‡Ø§ Ù…Ù†ØªØ¬ Ø£Ùˆ Ø®Ø¯Ù…Ø© Ø£Ùˆ Ø´Ø¹Ø§Ø±ØŒ ÙˆØµÙÙ‡.\"},{\"type\":\"image_url\",\"image_url\":{\"url\":\"data:image/jpeg;base64,{{ $json.data.base64 }}\"}}]}],\"max_tokens\":500}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        7984,
        5872
      ],
      "id": "dc54c8b9-7e40-498a-8e87-1a4fc2ded6bd",
      "name": "Analyze Image (Mistral)2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://access.mrailabs.com/api/log-usage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "api_key",
              "value": "Pi7HbQnp7lml2Ok30bBYq06dDbzD3oxxNEAdOQqeT38"
            },
            {
              "name": "execution_id",
              "value": "=n8n-exec-{{$executionId}}"
            },
            {
              "name": "request_type",
              "value": "chat"
            },
            {
              "name": "model",
              "value": "mistral-medium-2505"
            },
            {
              "name": "input_tokens",
              "value": "={{ $json.usage.prompt_tokens }}"
            },
            {
              "name": "output_tokens",
              "value": "={{ $json.usage.completion_tokens }}"
            },
            {
              "name": "platform_user_id",
              "value": "={{ $('User Phone ID').item.json.User_phone_ID }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        8128,
        5872
      ],
      "id": "14ee61b8-3845-4d04-b1c1-13faf89264cc",
      "name": "Cost Calculator4"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2f35809b-3889-4ef7-a8d5-a4d934842631",
              "name": "image",
              "value": "={{ $json.choices[0].message.content }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        8272,
        5872
      ],
      "id": "1f1383c6-a02b-45a8-b36e-e22c3f63f9b5",
      "name": "image"
    },
    {
      "parameters": {
        "resource": "chat-api",
        "operation": "get-media-base64",
        "instanceName": "={{ $('Whatsapp').first().json.body.instance }}",
        "messageId": "={{ $('Whatsapp').first().json.body.data.key.id }}"
      },
      "type": "n8n-nodes-evolution-api-english.evolutionApi",
      "typeVersion": 1,
      "position": [
        7488,
        6240
      ],
      "id": "bb5a4262-70ad-4792-b8f7-8a26b5fddd86",
      "name": "Get Stickers Base",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "evolutionApi": {
          "id": "IGwXyU5Jbou5S5V3",
          "name": "Business Number"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mrai-openai.services.ai.azure.com/models/chat/completions?api-version=2024-05-01-preview",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api-key",
              "value": "5zSQL871XpyGNXgzSx0LPwzkCrPqYj52L5ODHMA0bs6stZlhi35xJQQJ99BKACfhMk5XJ3w3AAABACOGk5RF"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "x-ms-model-mesh-model-name",
              "value": "mistral-medium-2505"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"model\":\"mistral-medium-2505\",\"messages\":[{\"role\":\"user\",\"content\":[{\"type\":\"text\",\"text\":\"ÙˆØµÙ Ø§Ù„ØµÙˆØ±Ø© Ø¯ÙŠ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø¨Ø´ÙƒÙ„ Ù…Ø®ØªØµØ±. Ù„Ùˆ ÙÙŠÙ‡Ø§ Ù†Øµ Ø£Ùˆ ÙƒÙ„Ø§Ù…ØŒ Ø§ÙƒØªØ¨Ù‡. Ù„Ùˆ ÙÙŠÙ‡Ø§ Ù…Ù†ØªØ¬ Ø£Ùˆ Ø®Ø¯Ù…Ø© Ø£Ùˆ Ø´Ø¹Ø§Ø±ØŒ ÙˆØµÙÙ‡.\"},{\"type\":\"image_url\",\"image_url\":{\"url\":\"data:image/jpeg;base64,{{ $json.data.base64 }}\"}}]}],\"max_tokens\":500}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        7984,
        6240
      ],
      "id": "a10ffb1a-6bcc-4d0b-a8d9-31fb4f47730f",
      "name": "Analyze Strickers (Mistral)3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2f35809b-3889-4ef7-a8d5-a4d934842631",
              "name": "Stickers",
              "value": "={{ $json.choices[0].message.content }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        8272,
        6240
      ],
      "id": "eed6d3d3-4579-40d4-847d-e9f56a7ea11e",
      "name": "Stickers"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a63db671-77e6-4370-b11f-92fc2767ee58",
              "name": "Memory Key",
              "value": "={{ $('User Phone ID').item.json.User_phone_ID }}",
              "type": "string"
            },
            {
              "id": "a12d20c8-7931-470c-a7df-70473f0be258",
              "name": "Input",
              "value": "={{ $if($('Text4').isExecuted, $('Text4').first().json.Text, \n   $if($('Voice').isExecuted, $('Voice').first().json.Voice, \n   $if($('image').isExecuted, 'Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø¹Øª ØµÙˆØ±Ø©. ÙˆØµÙ Ø§Ù„ØµÙˆØ±Ø©: ' + $('image').first().json.image, \n   'Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø¹Øª sticker: ' + $('Stickers').first().json.Stickers))) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        8528,
        5024
      ],
      "id": "3f811a31-e70d-4582-8de2-a8949e4e49de",
      "name": "Memory + Model PreEnter2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ca1744cf-69e7-4a85-81d3-2fb2b936e496",
              "name": "workflow_id",
              "value": "={{ $workflow.id }}",
              "type": "string"
            },
            {
              "id": "205c7c4d-2dfa-471f-9306-33d30e16722a",
              "name": "execution_id",
              "value": "={{ $execution.id }}",
              "type": "string"
            },
            {
              "id": "3fa4932f-c3cc-41a8-90a4-d1b3a2d32cdd",
              "name": "client_id",
              "value": "Be-Star",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        8720,
        5024
      ],
      "id": "4c014f39-d1d5-47d5-ab88-712a4867f509",
      "name": "Set metadata3"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Memory + Model PreEnter2').item.json.Input }}",
        "options": {
          "systemMessage": "You are a deterministic router+query-reformer for Mr. AI RAG.\nInputs:\n- current_message (string)\n- previous_messages (array of {role,content})\n- last_namespace (string|null)\n- detected_language (\"ar\"|\"en\")\n\nTask A â€” classify:\nChoose EXACTLY one label: Who_Are_We_And_Related_Information | Terms_And_Conditions_Data_Privacy_Policy | Practical_Case_Studies_and_why_us.\nRules: if vague/ack (\"ØªÙ…Ø§Ù…\",\"more?\") â†’ continue last_namespace; if multi-intent â†’ pick the primary intent; if confidence <0.5 â†’ Who_Are_We_And_Related_Information; greetings fall under Who_Are_We_And_Related_Information.\n\nTask B â€” reform:\nRewrite a concise semantic search query for the chosen label using context.\nKeep 5â€“20 tokens; preserve proper names, numbers, currency; add â‰¤2 helpful synonyms/domain terms; remove filler/pronouns; keep constraints (expert/service, date/time, locale, language).\nIf too vague, add a short HyDE (â‰¤25 tokens) describing what a relevant doc would say.\n\nStrict output (one line, minified JSON only):\n{\"category\":\"<label>\",\"query\":\"<short query>\",\"alternates\":[\"...\"],\"negative_terms\":[\"...\"],\"hyde\":\"...\",\"language\":\"ar|en\"}\n\nHard limits: total output â‰¤ ~80 tokens; no text outside JSON; no line breaks; no explanations; temperature low for stable routing.\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        8864,
        5024
      ],
      "id": "47e9e27f-8298-4b07-90d9-d02b4c946c74",
      "name": "Reformer"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Memory + Model PreEnter2').item.json['Memory Key'] }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        9024,
        5232
      ],
      "id": "f43f3ab3-c3c4-452b-8215-cd88a4009ae5",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "code": {
          "supplyData": {
            "code": "const { AzureChatOpenAI } = require(\"@langchain/openai\");\nconst azureOpenAIApiKey = \"5zSQL871XpyGNXgzSx0LPwzkCrPqYj52L5ODHMA0bs6stZlhi35xJQQJ99BKACfhMk5XJ3w3AAABACOGk5RF\";\nconst azureOpenAIApiInstanceName = \"mrai-openai\";\nconst azureOpenAIApiDeploymentName = \"gpt-4.1-mini\";\nconst azureOpenAIApiVersion = \"2024-08-01-preview\";\nconst input_token_cost = 0.40;\nconst output_token_cost = 1.60;\nconst tools = await this.getInputConnectionData('ai_tool', 0);\nconst googleSheetTool = tools[0];\nconst { workflow_id, execution_id, client_id } = $('Set metadata3').first().json;\nconst llm = new AzureChatOpenAI({\n  azureOpenAIApiKey, azureOpenAIApiInstanceName, azureOpenAIApiDeploymentName, azureOpenAIApiVersion,\n  temperature: 0.7,\n  callbacks: [{ handleLLMEnd: async function(output, runId, parentId) {\n    const generation = output.generations[0][0];\n    const message = generation.message;\n    const input_tokens = message.usage_metadata.input_tokens;\n    const output_tokens = message.usage_metadata.output_tokens;\n    const total_tokens = message.usage_metadata.total_tokens;\n    const input_cost_val = (input_tokens / 1_000_000) * input_token_cost;\n    const output_cost_val = (output_tokens / 1_000_000) * output_token_cost;\n    const total_cost = input_cost_val + output_cost_val;\n    const total_cost_in_egypt = total_cost * 50;\n    const row = { date: (new Date()).toGMTString(), workflow_id, execution_id, client_id, model: azureOpenAIApiDeploymentName, input_tokens, output_tokens, total_tokens, input_cost: input_cost_val, output_cost: output_cost_val, total_cost, total_cost_in_egypt };\n    if (googleSheetTool && googleSheetTool.func) { await googleSheetTool.func(row); }\n  } }]\n});\nreturn llm;"
          }
        },
        "inputs": {
          "input": [
            {
              "type": "ai_tool",
              "required": true
            }
          ]
        },
        "outputs": {
          "output": [
            {
              "type": "ai_languageModel"
            }
          ]
        }
      },
      "id": "fdd7f2c4-bf9f-40e6-ba7b-520bbdc26402",
      "name": "Azure OpenAI Chat Model5",
      "type": "@n8n/n8n-nodes-langchain.code",
      "position": [
        8784,
        5184
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://access.mrailabs.com/api/log-usage",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "api_key",
              "value": "Pi7HbQnp7lml2Ok30bBYq06dDbzD3oxxNEAdOQqeT38"
            },
            {
              "name": "execution_id",
              "value": "={{ $execution.id }}"
            },
            {
              "name": "workflow_id",
              "value": "={{ $workflow.id }}"
            },
            {
              "name": "platform_user_id",
              "value": "={{ $('Memory + Model PreEnter2').item.json['Memory Key'] }}"
            },
            {
              "name": "request_type",
              "value": "respond"
            },
            {
              "name": "model",
              "value": "={{ $json.model || 'gpt-4o-mini' }}"
            },
            {
              "name": "input_tokens",
              "value": "={{ $fromAI('input_tokens', ``, 'string') }}"
            },
            {
              "name": "output_tokens",
              "value": "={{ $fromAI('output_tokens', ``, 'string') }}"
            },
            {
              "name": "input_cost",
              "value": "={{ $fromAI('input_cost', ``, 'string') }}"
            },
            {
              "name": "output_cost",
              "value": "={{ $fromAI('output_cost', ``, 'string') }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        8848,
        5328
      ],
      "id": "62895ecc-eb6e-4ba7-8280-67953be52693",
      "name": "Log Reformer Rekaz"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ca1744cf-69e7-4a85-81d3-2fb2b936e496",
              "name": "workflow_id",
              "value": "={{ $workflow.id }}",
              "type": "string"
            },
            {
              "id": "205c7c4d-2dfa-471f-9306-33d30e16722a",
              "name": "execution_id",
              "value": "={{ $execution.id }}",
              "type": "string"
            },
            {
              "id": "3fa4932f-c3cc-41a8-90a4-d1b3a2d32cdd",
              "name": "client_id",
              "value": "Be-Star",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        9136,
        5008
      ],
      "id": "be2c6eed-d6b8-47b5-805f-7823b157116a",
      "name": "Set metadata4"
    },
    {
      "parameters": {
        "text": "={{ $('Reformer').item.json.output }}",
        "attributes": {
          "attributes": [
            {
              "name": "category",
              "description": "ØªØµÙ†ÙŠÙ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙ‚Ø·: Who_Are_We_And_Related_Information Ø£Ùˆ Practical_Case_Studies_and_why_us Ø£Ùˆ Terms_And_Conditions_Data_Privacy_Policy",
              "required": true
            },
            {
              "name": "reformer_data",
              "description": "ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ (query, alternates, negative_terms, hyde, language)",
              "required": true
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.informationExtractor",
      "typeVersion": 1.2,
      "position": [
        9280,
        5008
      ],
      "id": "b2c1d404-f9cb-4dca-8d53-0b7e8c18dea6",
      "name": "Information Extractor"
    },
    {
      "parameters": {
        "code": {
          "supplyData": {
            "code": "const { AzureChatOpenAI } = require(\"@langchain/openai\");\nconst azureOpenAIApiKey = \"5zSQL871XpyGNXgzSx0LPwzkCrPqYj52L5ODHMA0bs6stZlhi35xJQQJ99BKACfhMk5XJ3w3AAABACOGk5RF\";\nconst azureOpenAIApiInstanceName = \"mrai-openai\";\nconst azureOpenAIApiDeploymentName = \"gpt-4.1-mini\";\nconst azureOpenAIApiVersion = \"2024-08-01-preview\";\nconst input_token_cost = 0.40;\nconst output_token_cost = 1.60;\nconst tools = await this.getInputConnectionData('ai_tool', 0);\nconst googleSheetTool = tools[0];\nconst { workflow_id, execution_id, client_id } = $('Set metadata4').first().json;\nconst llm = new AzureChatOpenAI({\n  azureOpenAIApiKey, azureOpenAIApiInstanceName, azureOpenAIApiDeploymentName, azureOpenAIApiVersion,\n  temperature: 0.7,\n  callbacks: [{ handleLLMEnd: async function(output, runId, parentId) {\n    const generation = output.generations[0][0];\n    const message = generation.message;\n    const input_tokens = message.usage_metadata.input_tokens;\n    const output_tokens = message.usage_metadata.output_tokens;\n    const total_tokens = message.usage_metadata.total_tokens;\n    const input_cost_val = (input_tokens / 1_000_000) * input_token_cost;\n    const output_cost_val = (output_tokens / 1_000_000) * output_token_cost;\n    const total_cost = input_cost_val + output_cost_val;\n    const total_cost_in_egypt = total_cost * 50;\n    const row = { date: (new Date()).toGMTString(), workflow_id, execution_id, client_id, model: azureOpenAIApiDeploymentName, input_tokens, output_tokens, total_tokens, input_cost: input_cost_val, output_cost: output_cost_val, total_cost, total_cost_in_egypt };\n    if (googleSheetTool && googleSheetTool.func) { await googleSheetTool.func(row); }\n  } }]\n});\nreturn llm;"
          }
        },
        "inputs": {
          "input": [
            {
              "type": "ai_tool",
              "required": true
            }
          ]
        },
        "outputs": {
          "output": [
            {
              "type": "ai_languageModel"
            }
          ]
        }
      },
      "id": "77c626f0-3baa-4364-9f48-cff5c8e67b2d",
      "name": "Azure OpenAI Chat Model7",
      "type": "@n8n/n8n-nodes-langchain.code",
      "position": [
        9248,
        5184
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://access.mrailabs.com/api/log-usage",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "api_key",
              "value": "Pi7HbQnp7lml2Ok30bBYq06dDbzD3oxxNEAdOQqeT38"
            },
            {
              "name": "execution_id",
              "value": "={{ $execution.id }}"
            },
            {
              "name": "workflow_id",
              "value": "={{ $workflow.id }}"
            },
            {
              "name": "platform_user_id",
              "value": "={{ $('Memory + Model PreEnter2').item.json['Memory Key'] }}"
            },
            {
              "name": "request_type",
              "value": "respond"
            },
            {
              "name": "model",
              "value": "={{ $json.model || 'gpt-4o-mini' }}"
            },
            {
              "name": "input_tokens",
              "value": "={{ $fromAI('input_tokens', ``, 'string') }}"
            },
            {
              "name": "output_tokens",
              "value": "={{ $fromAI('output_tokens', ``, 'string') }}"
            },
            {
              "name": "input_cost",
              "value": "={{ $fromAI('input_cost', ``, 'string') }}"
            },
            {
              "name": "output_cost",
              "value": "={{ $fromAI('output_cost', ``, 'string') }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        9312,
        5328
      ],
      "id": "4b47c6d7-d993-4d59-90cd-311ba69d1980",
      "name": "Log Reformer Rekaz4"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "dd42c43a-f949-46c7-bc0c-79dc4472b3d3",
              "name": "Pinecone_Namespace",
              "value": "={{ $json.output.category }}",
              "type": "string"
            },
            {
              "id": "24500874-b716-4abc-9376-cb8ccb0ca25b",
              "name": "Reformer",
              "value": "={{ $json.output }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        9584,
        5024
      ],
      "id": "1aba9fc2-d101-4930-a5dd-14862171b052",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "mode": "load",
        "pineconeIndex": {
          "__rl": true,
          "value": "mr-ai-website-chatbot-knowledge-base",
          "mode": "list",
          "cachedResultName": "mr-ai-website-chatbot-knowledge-base"
        },
        "prompt": "={{ $json.Reformer }}",
        "topK": 12,
        "options": {
          "pineconeNamespace": "={{ $json.Pinecone_Namespace }}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStorePinecone",
      "typeVersion": 1.3,
      "position": [
        9712,
        5024
      ],
      "id": "3520038b-f00c-42ac-9894-aeb3e709459d",
      "name": "Pinecone Vector Store1",
      "credentials": {
        "pineconeApi": {
          "id": "swltCt6gosR03VPd",
          "name": "GH_Sales"
        }
      }
    },
    {
      "parameters": {
        "model": "text-embedding-3-large",
        "options": {
          "dimensions": 3072
        }
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsAzureOpenAi",
      "typeVersion": 1,
      "position": [
        9712,
        5184
      ],
      "id": "57431b9d-2a54-4ce7-a543-1c94448f3464",
      "name": "Embeddings Azure OpenAI",
      "credentials": {
        "azureOpenAiApi": {
          "id": "L4HdmJ5bGz2Owawh",
          "name": "Azure Open AI account"
        }
      }
    },
    {
      "parameters": {
        "fieldsToAggregate": {
          "fieldToAggregate": [
            {
              "fieldToAggregate": "document.pageContent"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        9984,
        5024
      ],
      "id": "1063ed24-a9ca-4e43-9d38-111900de27df",
      "name": "Aggregate1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2f35809b-3889-4ef7-a8d5-a4d934842631",
              "name": "Text from user",
              "value": "={{ $('Memory + Model PreEnter2').first().json.Input }}",
              "type": "string"
            },
            {
              "id": "8a4a05e2-9c61-48cc-a767-ddf3d426f69d",
              "name": "Text  from database",
              "value": "={{ $json.pageContent }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        10112,
        5024
      ],
      "id": "20a92d90-7226-4df6-a141-b823e82acb9f",
      "name": "Text3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ca1744cf-69e7-4a85-81d3-2fb2b936e496",
              "name": "workflow_id",
              "value": "={{ $workflow.id }}",
              "type": "string"
            },
            {
              "id": "205c7c4d-2dfa-471f-9306-33d30e16722a",
              "name": "execution_id",
              "value": "={{ $execution.id }}",
              "type": "string"
            },
            {
              "id": "3fa4932f-c3cc-41a8-90a4-d1b3a2d32cdd",
              "name": "client_id",
              "value": "Be-Star",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        10256,
        5024
      ],
      "id": "d40dfdc4-5264-4a0b-ba95-c26375cf77ae",
      "name": "Set metadata2"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Text3').item.json['Text from user'] }}",
        "options": {
          "systemMessage": "=Ø£Ù†Øª \"Ø¹Ù…Ø±\" Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ Ù„Ø­Ø¬Ø² ØªØ°Ø§ÙƒØ± ÙØ¹Ø§Ù„ÙŠØ© \"ÙƒÙ† Ù†Ø¬Ù…Ø§Ù‹ - Be Star\" ğŸŒŸ\nğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©:\nğŸ‰ Ø§Ù„Ø§Ø³Ù…: ÙƒÙ† Ù†Ø¬Ù…Ø§Ù‹ - Be Star\nğŸ“… Ø§Ù„Ù…ÙˆØ¹Ø¯: 11 ÙØ¨Ø±Ø§ÙŠØ± 2026\nğŸ“ Ø§Ù„Ù…ÙƒØ§Ù†: Ø³ÙˆÙ‡Ø§Ø¬ - Ø§Ù„ÙƒÙˆØ§Ù…Ù„ - Ù‚Ø§Ø¹Ø© Ù‚Ù†Ø§Ø© Ø§Ù„Ø³ÙˆÙŠØ³\nğŸ’° Ø§Ù„Ø£Ø³Ø¹Ø§Ø±:\n- VIP: 500 Ø¬Ù†ÙŠÙ‡\n- Ø·Ù„Ø¨Ø©: 100 Ø¬Ù†ÙŠÙ‡\nğŸ’³ Ø§Ù„Ø¯ÙØ¹: ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù… 01557368364\nØ§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ: {{ $now.format('dd/LLL/yyyy h:mm A') }}\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“‹ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©\nØ§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø§Ù„ØªØ±Ø­ÙŠØ¨ (Ø¹Ù„Ù‰ Ù‚Ø¯ Ø§Ù„Ø³Ø¤Ø§Ù„!)\nÙ„Ù…Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ¨Ø¹Øª ØªØ­ÙŠØ©:\n- \"ÙˆØ¹Ù„ÙŠÙƒÙ… Ø§Ù„Ø³Ù„Ø§Ù… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ğŸ˜Š Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ! Ù…Ø¹Ø§Ùƒ Ø¹Ù…Ø± Ù…Ù† ÙØ¹Ø§Ù„ÙŠØ© ÙƒÙ† Ù†Ø¬Ù…Ø§Ù‹. Ø£Ù‚Ø¯Ø± Ø£Ø³Ø§Ø¹Ø¯Ùƒ Ø¨Ø¥ÙŠÙ‡ØŸ\"\nâŒ Ù…Ø§ØªØ¹Ø±Ø¶Ø´ ØªÙØ§ØµÙŠÙ„ Ù‚Ø¨Ù„ Ù…Ø§ ÙŠØ³Ø£Ù„\n---\nØ§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©\n- Ø±Ø¯Ù‘ Ø¹Ù„Ù‰ Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø¸Ø¨Ø· (2-3 Ø¬Ù…Ù„)\n- Ù„Ùˆ Ø¹Ø§ÙŠØ² ÙŠØ­Ø¬Ø² â†’ ÙˆØ¬Ù‘Ù‡Ù‡ Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ø¬Ø²\n---\nØ§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø² (Ø³Ø¤Ø§Ù„ ÙˆØ§Ø­Ø¯/Ø±Ø³Ø§Ù„Ø©)\nâš ï¸ Ù„Ùˆ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù‚Ø§Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø© Ù‚Ø¨Ù„ ÙƒØ¯Ù‡ØŒ Ù…Ø§ØªØ³Ø£Ù„Ø´ Ø¹Ù„ÙŠÙ‡Ø§ ØªØ§Ù†ÙŠ.\n1. Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ\n2. Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ØŸ\n3. Ù†ÙˆØ¹ Ø§Ù„ØªØ°ÙƒØ±Ø© (VIP Ø£Ùˆ Ø·Ù„Ø¨Ø©)ØŸ\n4. Ø¹Ø¯Ø¯ Ø§Ù„ØªØ°Ø§ÙƒØ±ØŸ\n---\nØ§Ù„Ù…Ø±Ø­Ù„Ø© 4: Ø§Ù„Ø¯ÙØ¹\n\"ØªÙ…Ø§Ù… ÙŠØ§ ÙÙ†Ø¯Ù…! ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ [Ø§Ù„Ù…Ø¨Ù„Øº] Ø¬Ù†ÙŠÙ‡\n---\nØ§Ø¯ÙØ¹ Ø¹Ù„Ù‰ ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´: 01557368364\n---\nÙˆØ§Ø¨Ø¹ØªÙ„ÙŠ ØµÙˆØ±Ø© Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø¯ÙØ¹ Ø¹Ø´Ø§Ù† Ù†Ø£ÙƒØ¯ Ø§Ù„Ø­Ø¬Ø² âœ…\"\n---\nØ§Ù„Ù…Ø±Ø­Ù„Ø© 5: Ø§Ø³ØªÙ„Ø§Ù… Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹\nÙ„Ùˆ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø¹Øª ØµÙˆØ±Ø©:\n\"Ø´ÙƒØ±Ø§Ù‹ ÙŠØ§ ÙÙ†Ø¯Ù…! ğŸ“¸ Ø§Ø³ØªÙ„Ù…Ù†Ø§ Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø¯ÙØ¹. Ø§Ù„Ø£Ø¯Ù…Ù† Ù‡ÙŠØ±Ø§Ø¬Ø¹Ù‡ ÙˆÙ‡ÙŠØ¨Ø¹ØªÙ„Ùƒ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù‚Ø±ÙŠØ¨ Ø¥Ù† Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡ âœ…\"\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“¦ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:\n{{ $('Text3').item.json['Text  from database'] }}\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:\n{{ $if($('Access Control4').isExecuted, $('Access Control4').item.json.knowledge_base.additional_instructions, '') }}\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ Ø¹Ø±ÙˆØ¶ Ø­Ø§Ù„ÙŠØ§Ù‹:\n{{ $if($('Access Control4').isExecuted, $('Access Control4').item.json.knowledge_base.current_offers, '') }}\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâœ… Ù‚ÙˆØ§Ø¹Ø¯:\n- Ø³Ø¤Ø§Ù„ ÙˆØ§Ø­Ø¯ ÙÙŠ ÙƒÙ„ Ø±Ø³Ø§Ù„Ø©\n- Ø§Ø³ØªØ®Ø¯Ù… \"---\" Ù„ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø·ÙˆÙŠÙ„Ø©\n- Ø§ØªÙƒÙ„Ù… Ø¨Ø§Ù„Ø¹Ø§Ù…ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠØ© Ø§Ù„ÙˆØ¯ÙˆØ¯Ø©\n- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¨Ø§Ø¹ØªØ¯Ø§Ù„\n- Ù…Ø§ØªØ³ØªØ®Ø¯Ù…Ø´ markdown Ø£Ùˆ HTML\n- Ù…Ø§ØªÙƒØ±Ø±Ø´ Ø³Ø¤Ø§Ù„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø© Ø§ØªÙ‚Ø§Ù„Øª\n- Ù„Ùˆ Ø³Ø£Ù„ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: \"Ø¨Ø¹ØªØ°Ø± ÙŠØ§ ÙÙ†Ø¯Ù… ğŸ™ Ø£Ù†Ø§ ØªØ®ØµØµÙŠ ÙÙ‚Ø· ÙÙŠ ÙØ¹Ø§Ù„ÙŠØ© ÙƒÙ† Ù†Ø¬Ù…Ø§Ù‹\"\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nØ§Ù„ØªÙ†Ø³ÙŠÙ‚:\nâœ… Ù†Øµ Ø¹Ø§Ø¯ÙŠ | Ø¥ÙŠÙ…ÙˆØ¬ÙŠ | Ø£Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯Ø© | ---\nâŒ markdown | \\n | <br> | HTML tags\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
          "returnIntermediateSteps": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        10624,
        4864
      ],
      "id": "ba2c31bd-7da8-4c21-a901-7ab21dad8bc6",
      "name": "Be Star Ticketing Agent"
    },
    {
      "parameters": {
        "code": {
          "supplyData": {
            "code": "const { AzureChatOpenAI } = require(\"@langchain/openai\");\nconst azureOpenAIApiKey = \"5zSQL871XpyGNXgzSx0LPwzkCrPqYj52L5ODHMA0bs6stZlhi35xJQQJ99BKACfhMk5XJ3w3AAABACOGk5RF\";\nconst azureOpenAIApiInstanceName = \"mrai-openai\";\nconst azureOpenAIApiDeploymentName = \"gpt-4.1-mini\";\nconst azureOpenAIApiVersion = \"2024-12-01-preview\";\nconst input_token_cost = 0.40;\nconst output_token_cost = 1.60;\nconst tools = await this.getInputConnectionData('ai_tool', 0);\nconst googleSheetTool = tools[0];\nconst { workflow_id, execution_id, client_id } = $('Set metadata3').first().json;\nconst llm = new AzureChatOpenAI({\n  azureOpenAIApiKey, azureOpenAIApiInstanceName, azureOpenAIApiDeploymentName, azureOpenAIApiVersion,\n  temperature: 1,\n  callbacks: [{ handleLLMEnd: async function(output, runId, parentId) {\n    const generation = output.generations[0][0];\n    const message = generation.message;\n    const input_tokens = message.usage_metadata.input_tokens;\n    const output_tokens = message.usage_metadata.output_tokens;\n    const total_tokens = message.usage_metadata.total_tokens;\n    const input_cost_val = (input_tokens / 1_000_000) * input_token_cost;\n    const output_cost_val = (output_tokens / 1_000_000) * output_token_cost;\n    const total_cost = input_cost_val + output_cost_val;\n    const total_cost_in_egypt = total_cost * 50;\n    const row = { date: (new Date()).toGMTString(), workflow_id, execution_id, client_id, model: azureOpenAIApiDeploymentName, input_tokens, output_tokens, total_tokens, input_cost: input_cost_val, output_cost: output_cost_val, total_cost, total_cost_in_egypt };\n    if (googleSheetTool && googleSheetTool.func) { await googleSheetTool.func(row); }\n  } }]\n});\nreturn llm;"
          }
        },
        "inputs": {
          "input": [
            {
              "type": "ai_tool",
              "required": true
            }
          ]
        },
        "outputs": {
          "output": [
            {
              "type": "ai_languageModel"
            }
          ]
        }
      },
      "id": "6fc195f2-0015-4f73-9a14-6ec16095fd64",
      "name": "Azure OpenAI Chat Model4",
      "type": "@n8n/n8n-nodes-langchain.code",
      "position": [
        10416,
        5104
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Memory + Model PreEnter2').first().json['Memory Key'] }}",
        "tableName": "bestar_chat_history",
        "contextWindowLength": 50
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        10688,
        5232
      ],
      "id": "dce43c58-58bc-4029-a49d-cf75d12c77f4",
      "name": "Postgres Chat Memory1",
      "credentials": {
        "postgres": {
          "id": "nZpi0ecZbdqHX8nL",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://access.mrailabs.com/api/log-usage",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "api_key",
              "value": "Pi7HbQnp7lml2Ok30bBYq06dDbzD3oxxNEAdOQqeT38"
            },
            {
              "name": "execution_id",
              "value": "={{ $execution.id }}"
            },
            {
              "name": "workflow_id",
              "value": "={{ $workflow.id }}"
            },
            {
              "name": "platform_user_id",
              "value": "={{ $('Memory + Model PreEnter2').item.json['Memory Key'] }}"
            },
            {
              "name": "request_type",
              "value": "respond"
            },
            {
              "name": "model",
              "value": "={{ $json.model || 'gpt-4o-mini' }}"
            },
            {
              "name": "input_tokens",
              "value": "={{ $fromAI('input_tokens', ``, 'string') }}"
            },
            {
              "name": "output_tokens",
              "value": "={{ $fromAI('output_tokens', ``, 'string') }}"
            },
            {
              "name": "input_cost",
              "value": "={{ $fromAI('input_cost', ``, 'string') }}"
            },
            {
              "name": "output_cost",
              "value": "={{ $fromAI('output_cost', ``, 'string') }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        10576,
        5232
      ],
      "id": "77b114f8-8326-4ff1-993b-fd03e10da250",
      "name": "Log Reformer Rekaz3"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Original Query: {{ $('Memory + Model PreEnter2').item.json.Input }}\n\nDraft Answer: {{ $json.output }}",
        "options": {
          "systemMessage": "=You are a \"Compliance Filter\" for ÙƒÙ† Ù†Ø¬Ù…Ø§Ù‹ (Be Star). ğŸ›¡ï¸\nYour specific role is to PASS the \"Draft Answer\" to the user EXACTLY AS IT IS, unless a \"Fatal Error\" is detected.\n\n# ğŸš« FATAL ERRORS (ONLY THESE REQUIRE INTERVENTION):\n1. **Out of Scope**: Discussing politics, religion, cooking, medical advice, or coding unrelated to ÙƒÙ† Ù†Ø¬Ù…Ø§Ù‹ event.\n2. **Hallucination**: Promising a specific price or feature NOT present in the provided context.\n3. **Harmful/Rude**: Profanity or insults.\n\n# ğŸš¦ DECISION LOGIC (STRICT):\n- **IF NO FATAL ERROR IS FOUND:**\n  You MUST return the \"Draft Answer\" **WORD-FOR-WORD**.\n  - âŒ Do NOT summarize.\n  - âŒ Do NOT improve the style or tone.\n  - âŒ Do NOT change the dialect.\n  - âœ… **COPY & PASTE** the Draft Answer exactly.\n\n- **IF A FATAL ERROR IS FOUND:**\n  Only THEN, rewrite the answer to be a polite, formal refusal or correction (in Egyptian Arabic).\n  (Example: \"Ø¹Ø°Ø±Ø§Ù‹ ÙŠØ§ ÙÙ†Ø¯Ù…ØŒ Ø£Ù†Ø§ ØªØ®ØµØµÙŠ ÙÙ‚Ø· ÙÙŠ ÙØ¹Ø§Ù„ÙŠØ© ÙƒÙ† Ù†Ø¬Ù…Ø§Ù‹.\")"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.6,
      "position": [
        11696,
        4880
      ],
      "id": "5c6a7ebb-c03a-4549-ab07-7fa49cb63b9e",
      "name": "Guardrails Supervisor"
    },
    {
      "parameters": {
        "model": "gpt-4.1-mini",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatAzureOpenAi",
      "typeVersion": 1,
      "position": [
        11424,
        5264
      ],
      "id": "85498b7b-e653-4892-b997-d3f61e40b035",
      "name": "Azure OpenAI Chat Model1",
      "credentials": {
        "azureOpenAiApi": {
          "id": "L4HdmJ5bGz2Owawh",
          "name": "Azure Open AI account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Memory + Model PreEnter2').first().json['Memory Key'] }}",
        "tableName": "bestar_chat_history",
        "contextWindowLength": 50
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        11824,
        5296
      ],
      "id": "33584155-f433-4d4f-88e6-fef9d111b5bd",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "nZpi0ecZbdqHX8nL",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://access.mrailabs.com/api/log-message",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\"api_key\": \"Pi7HbQnp7lml2Ok30bBYq06dDbzD3oxxNEAdOQqeT38\", \"platform_user_id\": $('Memory + Model PreEnter2').item.json['Memory Key'], \"execution_id\": $execution.id, \"role\": \"user\", \"content\": $('Memory + Model PreEnter2').item.json['Input']}) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        12736,
        4976
      ],
      "id": "432c5ea9-2f67-44b5-a6c3-8d0d8d16e747",
      "name": "Log Usr Messages"
    },
    {
      "parameters": {
        "resource": "chat-api",
        "operation": "send-presence",
        "instanceName": "={{ $('Whatsapp').first().json.body.instance }}",
        "remoteJid": "={{ $('Whatsapp').first().json.body.data.key.remoteJid }}",
        "delay": 3000
      },
      "type": "n8n-nodes-evolution-api-english.evolutionApi",
      "typeVersion": 1,
      "position": [
        13536,
        5216
      ],
      "id": "98dc2f51-9118-43dc-ab1c-85b4464e48d5",
      "name": "Send presence1",
      "retryOnFail": true,
      "credentials": {
        "evolutionApi": {
          "id": "IGwXyU5Jbou5S5V3",
          "name": "Business Number"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const DELIMITER = '---';\nconst rawOutput = $('Guardrails Supervisor').first().json.output || '';\nif (!rawOutput || rawOutput.trim().length === 0) { return [{ json: { text: '' } }]; }\nconst hasDelimiter = rawOutput.includes(DELIMITER);\nlet messages = [];\nif (hasDelimiter) { messages = rawOutput.split(DELIMITER).map(msg => msg.trim()).filter(msg => msg.length > 0); }\nelse { messages = [rawOutput.trim()]; }\nmessages = messages.map(msg => msg.replace(/---/g, '').trim());\nmessages = messages.filter(msg => msg.length > 0);\nif (messages.length === 0) { const cleanedOriginal = rawOutput.replace(/---/g, '').trim(); return [{ json: { text: cleanedOriginal || 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.' } }]; }\nreturn messages.map(text => ({ json: { text } }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        13632,
        5440
      ],
      "id": "a1d9b95c-6e94-4cd7-9111-2b2b4473aa6d",
      "name": "Splite the messages"
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "={{ $('Whatsapp').first().json.body.instance }}",
        "remoteJid": "={{ $('Whatsapp').first().json.body.data.key.remoteJid }}",
        "messageText": "={{ $('Splite the messages').first().json.text }}",
        "options_message": {
          "quoted": {
            "messageQuoted": {
              "messageId": "={{ $('Whatsapp').first().json.body.data.key.id }}"
            }
          }
        }
      },
      "type": "n8n-nodes-evolution-api-english.evolutionApi",
      "typeVersion": 1,
      "position": [
        13808,
        5392
      ],
      "id": "198e6f25-e508-4bf0-b96a-350de8fa45b5",
      "name": "Send text",
      "retryOnFail": true,
      "executeOnce": true,
      "credentials": {
        "evolutionApi": {
          "id": "IGwXyU5Jbou5S5V3",
          "name": "Business Number"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://access.mrailabs.com/api/log-message",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "=json",
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "jsonBody": "={{ JSON.stringify({\"api_key\": \"Pi7HbQnp7lml2Ok30bBYq06dDbzD3oxxNEAdOQqeT38\", \"platform_user_id\": $('Memory + Model PreEnter2').first().json['Memory Key'], \"execution_id\": $execution.id, \"role\": \"assistant\", \"content\": $('Splite the messages').first().json.text}) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        13952,
        5392
      ],
      "id": "461da543-db3b-4e69-b7ee-370d52acfeee",
      "name": "Log AI Messages1"
    },
    {
      "parameters": {
        "jsCode": "const allItems = $('Splite the messages').all();\nif (allItems.length <= 1) { return []; }\nreturn allItems.slice(1);"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        13808,
        5552
      ],
      "id": "69fe3c09-ac5b-40ff-bb95-54efc0265803",
      "name": "Skip First One"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        13968,
        5552
      ],
      "id": "25a504b2-d07f-49aa-b437-f4a06e1f839b",
      "name": "Loop Over Items"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        14176,
        5408
      ],
      "id": "12c04e42-2767-4b85-981d-6c6bc88d9c93",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "={{ $('Whatsapp').first().json.body.instance }}",
        "remoteJid": "={{ $('Whatsapp').first().json.body.data.key.remoteJid }}",
        "messageText": "={{ $('Loop Over Items').item.json.text }}",
        "options_message": {}
      },
      "type": "n8n-nodes-evolution-api-english.evolutionApi",
      "typeVersion": 1,
      "position": [
        14144,
        5568
      ],
      "id": "147c0a6a-631f-4abd-be80-6482901e4fd4",
      "name": "Send text1",
      "retryOnFail": true,
      "credentials": {
        "evolutionApi": {
          "id": "IGwXyU5Jbou5S5V3",
          "name": "Business Number"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://access.mrailabs.com/api/log-message",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\"api_key\": \"Pi7HbQnp7lml2Ok30bBYq06dDbzD3oxxNEAdOQqeT38\", \"platform_user_id\": $('Memory + Model PreEnter2').item.json['Memory Key'], \"execution_id\": $execution.id, \"role\": \"assistant\", \"content\": $('Loop Over Items').item.json.text}) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        14336,
        5568
      ],
      "id": "b122c0c9-bd9f-4681-b0aa-ff3e6eb1fdee",
      "name": "Log AI Messages"
    },
    {
      "parameters": {
        "resource": "messages-api",
        "operation": "send-media",
        "instanceName": "Mr. AI",
        "remoteJid": "={{ $json.phone }}@s.whatsapp.net",
        "mediaUrl": "={{ $json.pdf_url }}",
        "mediaType": "document",
        "fileName": "={{ $json.code }}.pdf",
        "caption": "ğŸ« ØªØ°ÙƒØ±ØªÙƒ Ø¬Ø§Ù‡Ø²Ø©! Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ ÙˆÙ‚ØªØ§Ù‹ Ù…Ù…ØªØ¹Ø§Ù‹ ÙÙŠ ÙƒÙ† Ù†Ø¬Ù…Ø§Ù‹",
        "options_message": {}
      },
      "type": "n8n-nodes-evolution-api-english.evolutionApi",
      "typeVersion": 1,
      "position": [
        6176,
        6600
      ],
      "id": "33a8d0fa-3674-4d80-b5a7-f573c5c3d4f1",
      "name": "Send PDF Ticket",
      "credentials": {
        "evolutionApi": {
          "id": "IGwXyU5Jbou5S5V3",
          "name": "Business Number"
        }
      }
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "Mr. AI",
        "remoteJid": "={{ $json.phone }}@s.whatsapp.net",
        "messageText": "âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø­Ø¬Ø²Ùƒ Ø¨Ù†Ø¬Ø§Ø­!\n\nØ§Ø³Ù… Ø§Ù„Ø­Ø¶ÙˆØ±: {{ $json.name }}\nÙ†ÙˆØ¹ Ø§Ù„ØªØ°ÙƒØ±Ø©: {{ $json.ticket_type }}\nÙƒÙˆØ¯ Ø§Ù„ØªØ°ÙƒØ±Ø©: {{ $json.code }}\n\nğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: Ø³ÙˆÙ‡Ø§Ø¬ - Ø§Ù„ÙƒÙˆØ§Ù…Ù„ - Ù‚Ø§Ø¹Ø© Ù‚Ù†Ø§Ø© Ø§Ù„Ø³ÙˆÙŠØ³\nğŸ“… Ø§Ù„Ù…ÙˆØ¹Ø¯: 11 ÙØ¨Ø±Ø§ÙŠØ± 2026",
        "options_message": {}
      },
      "type": "n8n-nodes-evolution-api-english.evolutionApi",
      "typeVersion": 1,
      "position": [
        6416,
        6600
      ],
      "id": "46d07dee-2391-4c33-827d-f6d57e0a8547",
      "name": "Send Confirmation Text",
      "credentials": {
        "evolutionApi": {
          "id": "IGwXyU5Jbou5S5V3",
          "name": "Business Number"
        }
      }
    },
    {
      "parameters": {
        "content": "# Inputs\n",
        "height": 912,
        "width": 1376
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        7088,
        4816
      ],
      "id": "a948ff74-0000-0000-0000-000000000000",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "# Voice\n",
        "height": 256,
        "width": 976,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        7408,
        5408
      ],
      "id": "c17763e8-0000-0000-0000-000000000000",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## Text or Voice\n",
        "height": 208,
        "width": 208,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        7152,
        5440
      ],
      "id": "6e7f5b10-0000-0000-0000-000000000000",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "# Text\n",
        "height": 176,
        "width": 656,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        7648,
        4944
      ],
      "id": "20fa2687-0000-0000-0000-000000000000",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "# Anaysis image",
        "height": 304,
        "width": 1264
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        7168,
        5792
      ],
      "id": "da72f62f-0000-0000-0000-000000000000",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "# Anaysis stickers\n",
        "height": 240,
        "width": 1264
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        7168,
        6176
      ],
      "id": "73960d5d-0000-0000-0000-000000000000",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "# Orchestrator Agent\n",
        "height": 752,
        "width": 768,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        10384,
        4768
      ],
      "id": "12a57df2-0000-0000-0000-000000000000",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "# Rag \n",
        "height": 720,
        "width": 1920
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        8480,
        4768
      ],
      "id": "55bc4455-0000-0000-0000-000000000000",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## Mr Ai Guard ",
        "height": 752,
        "width": 1024,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        11360,
        4800
      ],
      "id": "58b87122-0000-0000-0000-000000000000",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "# Output\n",
        "height": 784,
        "width": 1536
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        12608,
        4704
      ],
      "id": "50162fcd-0000-0000-0000-000000000000",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## Whatsapp",
        "height": 192,
        "width": 560,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        13456,
        5184
      ],
      "id": "c5873594-0000-0000-0000-000000000000",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## Splite the messeges",
        "height": 384,
        "width": 924,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        13568,
        5376
      ],
      "id": "db56bba9-0000-0000-0000-000000000000",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## Approval Flow",
        "height": 240,
        "width": 560,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        5856,
        6528
      ],
      "id": "bestar-approval-sn-0000-0000-0000-000000000000",
      "name": "Sticky Note"
    }
  ],
  "connections": {
    "Whatsapp": {
      "main": [
        [
          {
            "node": "User Phone ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "User Phone ID": {
      "main": [
        [
          {
            "node": "Access Control4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Access Control4": {
      "main": [
        [
          {
            "node": "If8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If8": {
      "main": [
        [
          {
            "node": "Switch3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch3": {
      "main": [
        [
          {
            "node": "Text4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get media in base1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Image Base64",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Stickers Base",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Text4": {
      "main": [
        [
          {
            "node": "Memory + Model PreEnter2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get media in base1": {
      "main": [
        [
          {
            "node": "Convert to File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File": {
      "main": [
        [
          {
            "node": "Convert Audio Type3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert Audio Type3": {
      "main": [
        [
          {
            "node": "Transcribe a recording1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe a recording1": {
      "main": [
        [
          {
            "node": "Cost Calculator",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cost Calculator": {
      "main": [
        [
          {
            "node": "Voice",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Voice": {
      "main": [
        [
          {
            "node": "Memory + Model PreEnter2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Image Base64": {
      "main": [
        [
          {
            "node": "Analyze Image (Mistral)2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Image (Mistral)2": {
      "main": [
        [
          {
            "node": "image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "image": {
      "main": [
        [
          {
            "node": "Memory + Model PreEnter2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Stickers Base": {
      "main": [
        [
          {
            "node": "Analyze Strickers (Mistral)3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Strickers (Mistral)3": {
      "main": [
        [
          {
            "node": "Stickers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Stickers": {
      "main": [
        [
          {
            "node": "Memory + Model PreEnter2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Memory + Model PreEnter2": {
      "main": [
        [
          {
            "node": "Set metadata3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set metadata3": {
      "main": [
        [
          {
            "node": "Reformer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reformer": {
      "main": [
        [
          {
            "node": "Set metadata4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set metadata4": {
      "main": [
        [
          {
            "node": "Information Extractor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Information Extractor": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Pinecone Vector Store1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pinecone Vector Store1": {
      "main": [
        [
          {
            "node": "Aggregate1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate1": {
      "main": [
        [
          {
            "node": "Text3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Text3": {
      "main": [
        [
          {
            "node": "Set metadata2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set metadata2": {
      "main": [
        [
          {
            "node": "Be Star Ticketing Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "Reformer",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Log Reformer Rekaz": {
      "ai_tool": [
        [
          {
            "node": "Azure OpenAI Chat Model5",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Azure OpenAI Chat Model5": {
      "ai_languageModel": [
        [
          {
            "node": "Reformer",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Log Reformer Rekaz4": {
      "ai_tool": [
        [
          {
            "node": "Azure OpenAI Chat Model7",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Azure OpenAI Chat Model7": {
      "ai_languageModel": [
        [
          {
            "node": "Information Extractor",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Azure OpenAI": {
      "ai_embedding": [
        [
          {
            "node": "Pinecone Vector Store1",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Azure OpenAI Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "Be Star Ticketing Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Log Reformer Rekaz3": {
      "ai_tool": [
        [
          {
            "node": "Azure OpenAI Chat Model4",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory1": {
      "ai_memory": [
        [
          {
            "node": "Be Star Ticketing Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Be Star Ticketing Agent": {
      "main": [
        [
          {
            "node": "Guardrails Supervisor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Azure OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Guardrails Supervisor",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "Guardrails Supervisor",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Guardrails Supervisor": {
      "main": [
        [
          {
            "node": "Log Usr Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Usr Messages": {
      "main": [
        [
          {
            "node": "Send presence1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send presence1": {
      "main": [
        [
          {
            "node": "Splite the messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Splite the messages": {
      "main": [
        [
          {
            "node": "Skip First One",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send text": {
      "main": [
        [
          {
            "node": "Log AI Messages1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Skip First One": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send text1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send text1": {
      "main": [
        [
          {
            "node": "Log AI Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log AI Messages": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Approval Webhook": {
      "main": [
        [
          {
            "node": "Send PDF Ticket",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send PDF Ticket": {
      "main": [
        [
          {
            "node": "Send Confirmation Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "8df4082ac81111d2321c538ef34013493a96dd3b14b3af10e13ce9c3849e34d3"
  }
}